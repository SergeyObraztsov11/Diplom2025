import"./momentConfig-BtmrjjFW.js";import{r as $,q as R,o as s,h as r,g as ie,v as re,d as e,D as M,E as Q,G as q,H as B,I as J,J as F,K as ce,L as me,M as ue,N as de,O as pe,P as fe,u as O,Q as z,s as Y,j as T,t as y,f as g,w as k,_ as D,R as N,S as V,c as S,p as ve,T as ge,y as he,F as C,i as U,U as ye,m as we,n as xe,B as be,a as _e,b as ke,x as W,k as P}from"./index-BF_z3IxX.js";import"./lodash-BUlOZx_2.js";import{_ as Ce}from"./Track-BQH9ryPX.js";import{_ as Re}from"./TrackSkeleton-CJIF0NZv.js";import{u as $e,a as Ie,_ as Ae}from"./UserLayout-DbVbYj2Q.js";const Me={class:"flex w-full flex-col gap-2"},Se=["rows"],Ne={class:"flex flex-row items-center justify-end gap-2"},De=["disabled"],G={__name:"CreateComment",emits:["createComment","cancel"],setup(l,{emit:n}){const h=n,d=$(""),m=R(()=>d.value.length<=3||d.value.length>=100),p=()=>{h("cancel"),d.value=""},u=()=>{m.value||(h("createComment",d.value.trim()),d.value="")},f=R(()=>d.value.split(`
`).length||1);return(v,c)=>(s(),r("div",Me,[ie(e("textarea",{"onUpdate:modelValue":c[0]||(c[0]=i=>d.value=i),rows:f.value,class:"w-full bg-transparent resize-none border-b-2 border-main-white/50 focus:border-main-white focus:outline-none py-2 placeholder:text-main-white/50 transition-colors",placeholder:"Оставьте комментарий"},null,8,Se),[[re,d.value]]),e("div",Ne,[e("button",{type:"button",onClick:p,class:"px-4 py-2 text-main-white/50 hover:text-main-white transition-colors"}," Отмена "),e("button",{onClick:u,disabled:m.value,class:"px-4 py-2 bg-main-white/10 hover:bg-main-white/20 text-main-white rounded-full transition-colors disabled:opacity-50"},c[1]||(c[1]=[e("span",null,"Отправить",-1)]),8,De)])]))}},X={async fetchRootAlbumComments(l,n){const h=M(l,"albums",n),d=Q(B(l,"comments"),q("album","==",h),q("parent","==",null)),m=await J(d);return m.empty?(console.log("Комментарии не найдены"),[]):await Promise.all(m.docs.map(async u=>{const f=u.data(),v=await F(f.user),c=await F(f.album);return{id:u.id,text:f.text,createdAt:f.createdAt,likes:f.likes||0,replies:f.replies||0,user:{id:v.id,...v.data()},album:{id:c.id,...c.data()},parent:null}}))},async fetchReplyAlbumComments(l,n,h){const d=M(l,"albums",n),m=M(l,"comments",h),p=Q(B(l,"comments"),q("album","==",d),q("parent","==",m),ce("createdAt","asc")),u=await J(p);return await Promise.all(u.docs.map(async v=>{const c=v.data(),i=await F(c.user),t=await F(c.album),x=await F(c.parent);return{id:v.id,text:c.text,createdAt:c.createdAt,likes:c.likes,user:{id:i.id,...i.data()},album:{id:t.id,...t.data()},parent:{id:x.id,...x.data()}}}))}},Le={async uploadComment(l,n,h,d,m=null){const p=M(l,"albums",n),u=M(l,"users",d),f={text:h,album:p,user:u,createdAt:me(),likes:0,replies:0,parent:m?M(l,"comments",m):null};return m&&await ue(l,async c=>{const i=M(l,"comments",m),t=await c.get(i);if(t.exists()){const x=t.data().replies||0;c.update(i,{replies:x+1})}}),(await de(B(l,"comments"),f)).id}},H=pe("comments",()=>{const l=fe(),n=O();return{getAlbumRootComments:async p=>await X.fetchRootAlbumComments(l,p),getAlbumReplyComments:async(p,u)=>await X.fetchReplyAlbumComments(l,p,u),uploadComment:async(p,u,f=null)=>{const v=n.currentUserId;await Le.uploadComment(l,p,u,v,f)}}}),Fe={class:"flex w-full flex-col py-1 items-start gap-1"},Te={class:"flex flex-row w-full items-center gap-2"},je=["src"],qe={class:"flex flex-col gap-1"},Ue={class:"flex flex-row items-center gap-2"},Pe={class:"text-sm font-medium"},Be={class:"text-xs text-main-white/50"},Ye={class:"text-sm text-main-white/80"},Oe={class:"flex items-center justify-center transition-all"},ze={class:"flex flex-col gap-2"},Ve={__name:"ReplyComment",props:{comment:Object,updateRootComments:Function,updateReplyComments:Function},setup(l){const n=l,h=H(),d=z(),m=$(!1),p=R(()=>{const v=n.comment.createdAt?n.comment.createdAt.toDate():new Date,c=Y(),i=Y(v);return c.diff(i,"minutes")<60*24?i.fromNow():i.format("D MMMM YYYY")}),u=async v=>{await h.uploadComment(n.comment.album.id,v,n.comment.parent.id),await n.updateReplyComments(),await n.updateRootComments(),m.value=!1},f=()=>{d.openModal("report",{type:"comment",targetId:n.comment.id})};return(v,c)=>{var i;return s(),r("div",Fe,[e("div",Te,[(i=l.comment.user)!=null&&i.imageURL?(s(),r("img",{key:0,src:l.comment.user.imageURL,class:"w-8 h-8 rounded-full object-cover"},null,8,je)):T("",!0),e("div",qe,[e("div",Ue,[e("span",Pe,y(l.comment.user.displayName),1),e("span",Be,y(p.value),1)]),e("p",Ye,y(l.comment.text),1)]),g(V,null,{trigger:k(()=>[e("button",Oe,[g(D,{iconName:"MoreHorizIcon",class:"fill-white w-3 h-3"})])]),content:k(()=>[g(N,{onClick:f,iconName:"ReportIcon",isRed:!0,text:"Пожаловаться на комментарий"})]),_:1})]),e("div",ze,[m.value?(s(),S(G,{key:0,onCreateComment:u,onCancel:c[0]||(c[0]=t=>m.value=!1)})):(s(),r("button",{key:1,onClick:c[1]||(c[1]=t=>m.value=!0),class:"text-xs font-medium text-main-white/50 hover:text-white transition-colors"}," Ответить "))])])}}},Ge={class:"flex w-full flex-col py-2 items-start gap-1"},He={class:"flex flex-row w-full items-center gap-2"},Ee=["src"],Ke={class:"flex flex-col gap-1"},Qe={class:"flex flex-row items-center gap-2"},Je={class:"font-medium hover:underline hover:text-white"},We={class:"text-sm text-main-white/50"},Xe={class:"text-main-white/80"},Ze={class:"flex items-center justify-center transition-all"},et={class:"flex flex-col gap-2"},tt={key:0,class:"flex flex-col pl-6 border-l-2 border-main-gray gap-2"},at={__name:"RootComment",props:{comment:{type:Object,required:!0},updateRootComments:{type:Function,required:!0}},setup(l){const n=l,h=z(),d=H();O();const m=$(!1),p=$([]),u=$(!1),f=R(()=>n.comment.replies>0),v=async()=>{p.value=await d.getAlbumReplyComments(n.comment.album.id,n.comment.id)},c=async()=>{!m.value&&p.value.length===0&&await v(),m.value=!m.value},i=async b=>{await d.uploadComment(n.comment.album.id,b,n.comment.id),u.value=!1,await v(),await n.updateRootComments()},t=b=>b===1?"1 ответ":b>1&&b<5?`${b} ответа`:`${b} ответов`,x=()=>{h.openModal("report",{type:"comment",targetId:n.comment.id,targetUserId:n.comment.user.id})};return(b,I)=>{var A,j;return s(),r(C,null,[e("div",Ge,[e("div",He,[(A=l.comment.user)!=null&&A.imageURL?(s(),r("img",{key:0,src:l.comment.user.imageURL,class:"w-10 h-10 rounded-full object-cover"},null,8,Ee)):T("",!0),e("div",Ke,[e("div",Qe,[e("span",Je,y((j=l.comment.user)==null?void 0:j.displayName),1),e("span",We,y(ve(ge)(l.comment.createdAt)),1)]),e("p",Xe,y(l.comment.text),1)]),g(V,null,{trigger:k(()=>[e("button",Ze,[g(D,{iconName:"MoreHorizIcon",class:"fill-white w-4 h-4"})])]),content:k(()=>[g(N,{onClick:x,iconName:"ReportIcon",isRed:!0,text:"Пожаловаться на комментарий"})]),_:1})]),e("div",et,[u.value?(s(),S(G,{key:0,onCreateComment:i,onCancel:I[0]||(I[0]=L=>u.value=!1)})):(s(),r("button",{key:1,onClick:I[1]||(I[1]=L=>u.value=!0),class:"text-sm font-medium text-left text-main-white/50 hover:text-white transition-colors"}," Ответить ")),f.value?(s(),r("button",{key:2,onClick:c,class:"flex flex-row w-fit text-sm font-medium hover:text-white transition-colors"},[g(D,{iconName:"ArrowRightIcon",class:he(["fill-current transform transition-transform duration-200",m.value?"rotate-90":"-rotate-90"])},null,8,["class"]),e("span",null,y(m.value?"Скрыть":t(n.comment.replies)),1)])):T("",!0)])]),m.value?(s(),r("div",tt,[(s(!0),r(C,null,U(p.value,L=>(s(),S(Ve,{comment:L,updateRootComments:n.updateRootComments,updateReplyComments:v},null,8,["comment","updateRootComments"]))),256))])):T("",!0)],64)}}},st={class:"flex flex-col lg:flex-row gap-4"},lt={class:"flex flex-col flex-1 gap-4"},nt={class:"flex flex-row gap-4"},ot={class:"w-48 h-48 flex-shrink-0 overflow-hidden rounded-lg"},it={class:"flex flex-col justify-around w-full"},rt={key:0,class:"h-9 md:h-12 w-64 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},ct={key:1,class:"text-4xl font-bold tracking-tight text-white truncate"},mt={key:2,class:"flex gap-2"},ut={key:3,class:"flex items-end gap-2 text-white/80 truncate"},dt={class:"text-sm whitespace-nowrap"},pt={class:"flex items-center gap-3"},ft={class:"p-2 flex items-center justify-center hover:scale-110 transition-all"},vt={class:"flex flex-col gap-4"},gt={class:"flex flex-row gap-4 items-center justify-between"},ht={class:"text-lg font-bold"},yt={class:"flex flex-col gap-2"},wt={class:"lg:max-w-80 lg:w-fit lg:min-w-60 space-y-6"},xt={key:0,class:"space-y-2"},bt={key:1,class:"text-base text-main-white text-pretty"},_t={class:"flex items-center gap-3 mb-3"},kt={key:0,class:"w-12 h-12 rounded-full bg-main-gray animate-pulse"},Ct={class:"flex-1"},Rt={key:0,class:"space-y-2"},$t={key:1,class:"justify-around"},It={class:"text-base text-main-white/50"},At={key:0,class:"space-y-2"},Mt={key:1,class:"text-base text-pretty line-clamp-5"},St={key:0,class:"space-y-2"},Nt={key:1,class:"space-y-2 text-base"},Ut={__name:"AlbumPage",props:{albumId:{type:String,required:!0}},setup(l){const n=l,h=be(),d=_e(),m=$e(),p=ye();O();const u=we(),f=H(),v=Ie(),c=z(),i=$(!0),t=$({}),x=$([]),b=R(()=>t.value.createdAt?Y(t.value.createdAt.toDate()).format("D MMMM YYYY"):"Дата создания не указана"),I=async()=>{x.value=await f.getAlbumRootComments(n.albumId)},A=R(()=>{var o;return(o=u.likedAlbums)==null?void 0:o.includes(t.value.id)}),j=()=>{var _;const o=(_=h.query)==null?void 0:_.trackId,a=t.value.tracks.map(w=>w.id);if(o&&a.includes(o)){v.playTrackList({id:h.query.trackId,trackList:a});const w={...h.query};delete w.trackId,d.replace({name:h.name,params:h.params,query:w})}};xe(async()=>{i.value=!0;try{const o=await u.getAlbumById(n.albumId),a=await m.getTracksById(o.tracks.map(_=>_.id));t.value={...o,tracks:a},x.value=await f.getAlbumRootComments(n.albumId),j()}catch(o){p.showMessage("Ошибка при загрузке альбома"),console.log(o),d.push({name:"home"})}finally{i.value=!1}});const L=async o=>{await f.uploadComment(t.value.id,o),await I()},E=()=>{const o=t.value.tracks[0].id;v.playTrackList({id:o,trackList:t.value.tracks.map(a=>a.id)})},K=async()=>{A.value?await u.dislikeAlbum(t.value.id):await u.likeAlbum(t.value.id)},Z=async()=>{try{await navigator.clipboard.writeText(window.location.href),p.showMessage(`Ссылка на альбом ${t.value.title} успешно скопирована.`)}catch{p.showMessage("Произошла ошибка при копированнии ссылки.")}},ee=()=>{c.openModal("report",{type:"album",targetId:t.value.id,targetUserId:t.value.author.id})},te=R(()=>x.value.reduce((o,a)=>o+1+(a.replies||0),0)),ae=o=>o===1?"1 комментарий":o>1&&o<5?`${o} комментария`:`${o} комментариев`,se=R(()=>{var a;return((a=[{label:"Поп-музыка",value:"pop"},{label:"Рэп и хип-хоп",value:"rap-hip-hop"},{label:"Танцевальная",value:"dance"},{label:"Классическая",value:"classic"},{label:"Блюз",value:"blues"},{label:"Панк",value:"punk"},{label:"R&B",value:"r-b"},{label:"Другое",value:"other"}].find(_=>_.value===t.value.genre))==null?void 0:a.label)||"Жанр не указан"}),le=o=>o===1?"1 слушатель":o>=1e6?`${(o/1e6).toFixed(1)}M слушателей`:o>=1e3?`${(o/1e3).toFixed(1)}K слушателей`:`${o} слушателей`;return(o,a)=>{const _=ke("RouterLink");return s(),S(Ae,null,{default:k(()=>[e("div",st,[e("section",lt,[e("div",nt,[e("div",ot,[g(W,{url:t.value.imageURL,class:"w-full h-full shadow-xl",icon:"playlist"},null,8,["url"])]),e("div",it,[a[5]||(a[5]=e("p",{class:"text-sm font-medium text-white/80"},"Альбом",-1)),i.value?(s(),r("div",rt)):(s(),r("h1",ct,y(t.value.title),1)),i.value?(s(),r("div",mt,a[0]||(a[0]=[e("div",{class:"h-5 w-32 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-24 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1)]))):(s(),r("div",ut,[g(_,{class:"text-sm font-medium hover:text-white hover:underline truncate",to:{name:"artist",params:{artistId:t.value.author.id}}},{default:k(()=>[P(y(t.value.author.displayName),1)]),_:1},8,["to"]),a[1]||(a[1]=P(" • ")),e("span",dt,y(b.value),1)])),e("div",pt,[i.value?(s(),r(C,{key:0},[a[2]||(a[2]=e("div",{class:"bg-main-gray animate-pulse rounded-full w-10 h-10"},null,-1)),a[3]||(a[3]=e("div",{class:"bg-main-gray animate-pulse rounded-full w-8 h-8"},null,-1)),a[4]||(a[4]=e("div",{class:"bg-main-gray animate-pulse rounded-full w-8 h-8"},null,-1))],64)):(s(),r(C,{key:1},[e("button",{onClick:E,title:"Слушать",class:"p-2 flex items-center justify-center bg-main-color hover:bg-blue-600 rounded-full transition-all"},[g(D,{iconName:"PlayArrowIcon",class:"fill-white w-6 h-6"})]),e("button",{onClick:K,title:"Нравится",class:"p-2 flex items-center justify-center hover:scale-110 transition-all"},[g(D,{iconName:A.value?"FavoriteFillIcon":"FavoriteIcon",class:"fill-white w-6 h-6"},null,8,["iconName"])]),g(V,null,{trigger:k(()=>[e("button",ft,[g(D,{iconName:"MoreHorizIcon",class:"fill-white w-6 h-6"})])]),content:k(()=>[g(N,{onClick:E,iconName:"PlayArrowIcon",text:"Слушать"}),g(N,{onClick:K,iconName:A.value?"FavoriteFillIcon":"FavoriteIcon",text:A.value?"Нравится":"Не нравится"},null,8,["iconName","text"]),g(N,{onClick:Z,iconName:"ShareIcon",text:"Копировать ссылку"}),g(N,{onClick:ee,iconName:"ReportIcon",isRed:!0,text:"Пожаловаться на альбом"})]),_:1})],64))])])]),e("div",vt,[i.value?(s(),r(C,{key:1},U(5,w=>g(Re,{"is-show-image":!1,key:w})),64)):(s(!0),r(C,{key:0},U(t.value.tracks,(w,ne)=>(s(),S(Ce,{"is-show-image":!1,index:ne+1,key:w.id,data:w,list:t.value.tracks.map(oe=>oe.id)},null,8,["index","data","list"]))),128))]),i.value?T("",!0):(s(),r(C,{key:0},[e("div",gt,[e("span",ht,y(ae(te.value)),1)]),g(G,{onCreateComment:L}),e("div",yt,[(s(!0),r(C,null,U(x.value,w=>(s(),S(at,{key:w.id,comment:w,updateRootComments:I},null,8,["comment"]))),128))])],64))]),e("section",wt,[e("div",null,[a[7]||(a[7]=e("h2",{class:"text-xl font-bold mb-3"},"Об альбоме",-1)),i.value?(s(),r("div",xt,a[6]||(a[6]=[e("div",{class:"h-5 w-full bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-3/4 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-5/6 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1)]))):(s(),r("p",bt,y(t.value.description),1))]),e("div",null,[a[10]||(a[10]=e("h2",{class:"text-xl font-bold mb-3"},"Об исполнителе",-1)),e("div",_t,[i.value?(s(),r("div",kt)):(s(),S(_,{key:1,class:"w-12 h-12 rounded-full overflow-hidden",to:{name:"artist",params:{artistId:t.value.author.id}}},{default:k(()=>[g(W,{url:t.value.author.imageURL,class:"w-full h-full"},null,8,["url"])]),_:1},8,["to"])),e("div",Ct,[i.value?(s(),r("div",Rt,a[8]||(a[8]=[e("div",{class:"h-6 w-32 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-24 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1)]))):(s(),r("div",$t,[g(_,{class:"text-base font-semibold hover:text-white hover:underline truncate",to:{name:"artist",params:{artistId:t.value.author.id}}},{default:k(()=>[P(y(t.value.author.displayName),1)]),_:1},8,["to"]),e("p",It,y(le(t.value.author.listenersCount)),1)]))])]),i.value?(s(),r("div",At,a[9]||(a[9]=[e("div",{class:"h-5 w-full bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-4/5 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1)]))):(s(),r("p",Mt,y(t.value.author.description),1))]),e("div",null,[a[12]||(a[12]=e("h2",{class:"text-xl font-bold mb-3"},"Детали",-1)),i.value?(s(),r("div",St,a[11]||(a[11]=[e("div",{class:"h-5 w-36 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-24 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1),e("div",{class:"h-5 w-32 bg-main-light-gray dark:bg-main-gray rounded animate-pulse"},null,-1)]))):(s(),r("div",Nt,[e("p",null,"Дата выхода: "+y(b.value),1),e("p",null,"Жанр: "+y(se.value),1)]))])])])]),_:1})}}};export{Ut as default};
